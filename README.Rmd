---
title:  "Datapaper Draft: Standardized datasets of Brazilian reef biodiversity in space and time"
author: "Reef Synthesis Working Group; Luza, AL, Cordeiro, CAMM, ..., Aued, AW, Ferreira, CEL, Mendes, T., Roos, N, Longo, GO, Francini-Filho, RB, Floeter, SR, Bender, MG"
date: "2022/08/16"
output: github_document
---


<!-- README.md is generated from README.Rmd. Please edit that file -->

<!-- badges: start -->
<!-- badges: end -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Paper section 1: Ecological Synthesis, and who are we?

The leveraging of ecological synthesis has two main reasons: ecology is both entering in the age of big data (Wüest et al. 2020) and applying the principles of open science (UNESCO 2021). We are now experiencing a transition from isolated research, with data stored locally, to a global research network with data stored in public repositories available to be used for fuelling further research (Reichman et al. 2011). Brazil have just started to track this trend. The 'Sinbiose', the Brazilian Institute of Synthesis in Biodiversity and Ecosystem Services (see <http://www.sinbiose.cnpq.br/web/sinbiose/home>), comprises a pioneer initiative within Latin America in terms of ecological synthesis and application of open-science principles (UNESCO 2020). There are seven working groups funded by the Sinbiose institute, being the ReefSYN--**ReefSYN Working Group**  
--the only group working with marine ecosystems (particularly biogenic and rocky reefs of the Brazilian marine biogeographical province (Spalding et al. 2007)).

The ReefSYN is composed of a team with 22 researchers (20 early-career and senior researchers, assisted by two post-doctoral researchers) from several countries and institutions  (Fig. 1). Up to this date, most team members performed research in isolation, each one covering a specific dimension of reef biodiversity (Fig. 1). By getting funding and support from the Sinbiose we have now the chance to make data synthesis and bring together different research expertise and perspectives to engage into a common objective: *Provide a synthesis about patterns and drivers of reef diversity and ecological services provision  in Brazil*. More information about our group can be found at <https://reefsyn.weebly.com/home-us.html>.


```{r, echo = F, fig.height=6.5,fig.width=6.5,fig.margin=F,fig.align="center", message=F,warning=F,out.width="100%",out.height="100%"}


## R code to load data sets and plot points
## call packages

source("R/packages.R")
source("R/functions.R")

# open researcher data
researcher_data <- read.xlsx(here::here("Data","researcher_data","PLANILHA_CONSOLIDADA.xlsx"), sheet = 1, colNames = TRUE, detectDates=F)
# formatting data
researcher_data$objetivos <- as.character (researcher_data$objetivos)
researcher_data$titulo_portugues <- as.character (researcher_data$titulo_portugues)
researcher_data$titulo_ingles <- as.character (researcher_data$titulo_ingles)

## extrair as colunas que desejo analaisar
institution <- strsplit(researcher_data$instituicao,",")
institution <- unlist(strsplit(unlist(institution), "/"))
institution <- gsub (" ","",institution)
# df for word-cloud
institution <- data.frame (inst=unique(institution) [order (unique(institution))],
                           freq=table(institution) [order (names(table(institution)))])

### titulo em ingles
titulo_ingles <- as.character (researcher_data$titulo_ingles [which(researcher_data$titulo_ingles != "Indefinido")])
## gerar df para o wcloud
freq_texto_wc <-  function_freq_texto_wc (titulo_ingles)

par(mfrow=c(1,2),mar=rep(0, 4))

## inst
wordcloud(words = institution$inst, freq = institution$freq.Freq,
          min.freq = 1,scale=c(4, .2),
          max.words=50, 
          random.order=FALSE, rot.per=0.15, 
          colors = RColorBrewer::brewer.pal(8, "Dark2"))


# tit english
wordcloud(words = freq_texto_wc$word, 
          freq = freq_texto_wc$freq.Freq,
          min.freq = 2,scale=c(4, .2),
          max.words=max(freq_texto_wc$freq.Freq)+3, 
          random.order=FALSE, rot.per=0.15, 
          colors = RColorBrewer::brewer.pal(8, "Dark2"))



```
Fig. 1: Institutions and research topics explored by the ReefSYN team members.

# Paper section 2: Spatial and temporal distribution of data gathered by the ReefSYN Working Group

Over time (since 2001 actually), this team of researchers gathered data on fish and benthic organisms (e.g., algae, corals) in different localities scattered throughout the Brazilian coast and oceanic islands. By standardizing these data to a common, globally accepted standard --the Darwin Core Standard-- it would be possible to integrate data and make data synthesis to answer more ambitious questions about the functioning of Brazilian reef ecosystems, as well quantify, given the distribution of data in space and time, the influence of humans on reef biodiversity and ecosystem services. Below, we make a spatial mapping of our data and show how the accumulation of sample and taxonomic information in time and space proceeded.

The use of big data is natural to ecological synthesis, considering data amount and heterogeneity (Wüest et al. 2020). To achieve our objective, we are analyzing data from almost 400 unique localities distributed throughout the Brazilian coast and oceanic islands. Our data embraces a notable latitudinal range, from 0.91N to 27.6S latitude degrees, and cover a significant portion of the Atlantic Ocean. In these localities, we gathered and standardized both already published and unpublished data on fish and benthic communities to create this large database under the curatorship of the ReefSYN Working Group. In brief, all these data came from geographically replicated, large-scale research programs conducted over the last decades in Brazil (SISBOTA-MAR, PELD-ILOC, Abrolhos Bank monitoring) and from novel initiatives such as the monitoring of reef fish and benthos of Rio Grande do Norte state. Below we present the map with the spatial distribution of localities aggregated across datasets, for fish and benthic organisms (see legend, Fig. 2). 


```{r, echo = F, fig.height=5, fig.width=8, message=F, warning=F, fig.align= "center", out.width="100%", out.height="100%"}

# load Datasets
# benthos
ds1<- read.csv (here::here("DwC_output", "AAued_spatialData", "event_core.csv"))
ds2<- read.csv (here::here("DwC_output", "GLongo_NRoss_spatialData", "event_core_benthos.csv"))
ds3<- read.table (here::here("DwC_output","PELD_iloc_benthos", "event_core.txt"),h=T,sep=",")
colnames(ds3)[which(colnames(ds3) == "island")] <- "site"
colnames(ds3)[which(colnames(ds3) == "eventYear")] <- "year"
ds3$higherGeography <- "BrazilianOceanicIslands"
ds4<- read.csv (here::here("DwC_output","RFrancini_spatialData", "event_core.csv"))
ds5<- read.csv (here::here("DwC_output","RFrancini_timeSeries_abrolhos","event_core_benthos.csv"))

# fish
ds6<- read.csv (here::here("DwC_output","GLongo_NRoss_spatialData", "event_core_fish.csv"))
ds7<- read.csv (here::here("DwC_output","GLongo_spatialData", "event_core.csv"))
ds8<- read.table (here::here("DwC_output","PELD_iloc_fish", "event_core.txt"),h=T, sep= ";")
colnames(ds8)[which(colnames(ds8) == "island")] <- "site"
colnames(ds8)[which(colnames(ds8) == "eventYear")] <- "year" # 
ds8 <- ds8 [which(ds8$site != "Ascension"),] # removing Ascension
ds8$higherGeography <- "BrazilianOceanicIslands"
ds9<- read.csv (here::here("DwC_output","RFrancini_timeSeries_abrolhos","event_core_fish.csv"))
ds10<- read.csv (here::here("DwC_output","RJ_time_series", "event_core.csv"))
ds11<- read.csv (here::here("DwC_output","RMorais_spatialData", "event_core.csv"))
ds12<- read.csv (here::here("DwC_output","SC_time_series", "event_core.csv"))


# list of sites with sampling of benthic communities
list_benthos <- list(data.frame (ds1, Dataset= "Sisbiota-Mar"),
                     data.frame (ds2, Dataset="RN monitoring"),
                     data.frame (ds3, Dataset ="PELD ILOC"),
                     data.frame (ds4, Dataset = "Coastal snapshots"),
                     data.frame (ds5, Dataset = "Abrolhos Bank"))



# agggregate and get coordinates for each site
coords <- lapply (list_benthos, function (i) 
  
  
  dplyr::group_by(i, Dataset, higherGeography, site, locality) %>% 
  
                    summarise(decimalLatitude = mean(decimalLatitude),
                            decimalLongitude = mean(decimalLongitude)) %>% 
    
                  select (higherGeography, site, locality,
                          decimalLatitude, decimalLongitude)
)

# melt
coords <- do.call(rbind, coords)


# map
# mapa mundi
world <- ne_countries(scale = "medium", returnclass = "sf")

# cortar o mapa para ver a america do Sul e parte da central
wm <- ggplot() + 
  geom_sf (data=world, size = 0.1, 
           fill= "gray90",colour="gray90") +
  coord_sf (xlim = c(-50, -25),  ylim = c(-30, 4), expand = FALSE) +
  theme_bw() + xlab ("Longitude")  + ylab ("Latitude") +
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "lightcyan",#darkslategray1
                                        colour = "lightcyan"),
        
        axis.text.x = element_text(size=6),
        axis.ticks.x=element_line(size=1),
        axis.text.y = element_text(size=6),
        axis.ticks.y=element_line(size=1),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        title = element_text(size=9)) 

# map
wm_data <- wm +  geom_jitter(data = coords, 
                             aes(x = decimalLongitude, 
                                 y = decimalLatitude,
                                 col = Dataset,
                                 fill=Dataset), 
                            size =4, position= "jitter",
                            stat = "identity",
        shape = 19, alpha=0.3) +
  theme (plot.background = element_rect("#EBEBEB"),
        #panel.background = element_blank(),
        axis.title = element_text(color = "#292929", face = "bold"),
        axis.text = element_text(color = "#292929", face = "bold"),
         legend.text = element_text(size =6),
        legend.title = element_text(size =7),
        legend.key.height= unit(0.3, 'cm'),
        legend.key.width= unit(0.1, 'cm'),
        panel.grid = element_blank())+
  scale_colour_viridis_d(option="magma", end=0.8)+
  ggtitle (paste ("Data of benthic communities", "n=", nrow(coords), sep=" "))  +
  guides(colour = guide_legend(override.aes = list(alpha=1)))


# ================
# fish

list_fish <- list(data.frame (ds6, Dataset = "RN monitoring"),
                  data.frame (ds7, Dataset = "Sisbiota-Mar (VP)"),
                  data.frame (ds8, Dataset = "PELD ILOC"),
                  data.frame (ds9, Dataset = "Abrolhos Bank"),
                  data.frame (ds10, Dataset = "Arraial do Cabo"),
                  data.frame (ds11, Dataset = "Sisbiota-Mar (UVC)"),
                  data.frame (ds12, Dataset = "Santa Catarina"))


# agggregate and get coordinates for each site
coords_fish <- lapply (list_fish, function (i) 
  
  
  group_by(i, Dataset, higherGeography, site, locality) %>% 
  
                    summarise(decimalLatitude = mean( decimalLatitude,na.rm=T),
                            decimalLongitude = mean( decimalLongitude,na.rm=T)) %>% 
    
                  select (higherGeography,site, locality,
                          decimalLatitude,decimalLongitude)
)

# melt
coords_fish <- do.call(rbind,coords_fish)


# map
wm_data_fish <- wm + geom_point(data = data.frame(coords_fish), aes(x = decimalLongitude, 
                                                         y = decimalLatitude,
                                                         col = Dataset,
                                                         fill=Dataset), 
                            size =4, position= "jitter",
        shape = 19, alpha=0.3) + 
  scale_colour_viridis_d(direction=1)+
  theme (plot.background = element_rect("#EBEBEB"),
        #panel.background = element_blank(),
        axis.title = element_text(color = "#292929", face = "bold"),
        axis.text = element_text(color = "#292929", face = "bold"),
        legend.text = element_text(size =6),
        legend.title = element_text(size =7),
        legend.key.height= unit(0.3, 'cm'),
        legend.key.width= unit(0.1, 'cm'),
        panel.grid = element_blank())+
  ggtitle (paste ("Data of fish commnities", "n=", nrow(coords_fish), sep=" ")) +
  guides(colour = guide_legend(override.aes = list(alpha=1))) 

library(patchwork)
wm_data + wm_data_fish

```
Fig. 2: Spatial distribution of sampling sites of benthos (right) and fish (left) per dataset.


# Paper section 3: Temporal trends on data acquisition

The dataset presented here reunites information from several independent and geographically replicated efforts to characterize the marine biodiversity of the Brazilian province in space and time (Fig. 3). In terms of the cumulative number of eventIDs (i.e. information associated with an Event of sampling - something that occurs at a place and time - sensu Darwin Core Task Group (2009)) across the datasets over time, we can see that i) there was an abrupt increase in the number of eventIDs after 2013, mainly for benthos (probably leveraged by the Sisbiota-Mar project (CNPq)), and ii) the data included several initiatives (e.g., Sisbiota-Mar, PELD ILOC) from past expeditions (i.e., prior to the first conjunct grant).

The number of sampling events per dataset, for benthos and fish, are shown in Tables 1 and 2, respectively.


Table 1: number of sampling events of benthos sampling, per dataset.

```{r, echo = F, results='asis'}

## Benthos
# the number of sampling events per dataset

table_description_data_benthos <- lapply (list_benthos, function (i)
  
    data.frame (samplingProtocol = unique(i$samplingProtocol),
                eventIDs = table(i$samplingProtocol),
                Dataset = unique(i$Dataset))
)

# melt
table_description_data_benthos <- do.call(rbind,table_description_data_benthos)
table_description_data_benthos$samplingProtocol <- firstup(table_description_data_benthos$samplingProtocol)
#sum(table_description_data_benthos$eventIDs)

table_description_data_benthos %>% 
  mutate(samplingProtocol = recode(samplingProtocol, "Photoquadrats" = "Photoquadrats (50 X 50cm)",
                                   "Point-intercept  lines" = "Point-intercept lines")) %>% 
  dplyr::rename("Sampling Protocol" = "samplingProtocol",
                "samples (n)" = "eventIDs.Freq") %>% 
  kable()

## IDENTIFICAR QUAL A MEDIDA E DIMENSOES DAS AMOSTRAS EM CADA DATASET

```



Table 2: number of sampling events of fish sampling, per dataset.

```{r, echo = F, results='asis'}


## Fish
# the number of sampling events per dataset

table_description_data_fish <- lapply (list_fish, function (i)
  
    data.frame (samplingProtocol = unique(i$samplingProtocol),
                eventIDs = table(i$samplingProtocol),
                Dataset = unique(i$Dataset))
)

# melt
table_description_data_fish <- do.call(rbind,table_description_data_fish)
table_description_data_fish$samplingProtocol <- firstup(table_description_data_fish$samplingProtocol)

# totals
# sum(table_description_data_fish$eventIDs)

table_description_data_fish %>% 
  mutate(samplingProtocol = recode(samplingProtocol, "Underwater visual survey - 20 x 2m" = "Underwater visual survey",
                                   "Underwater Visual Survey - 20 x 2m" = "Underwater visual survey",
                                   "Stationary visual census - 4 x 2m" = "Stationary visual census"),
         eventIDs.Var1 = recode(eventIDs.Var1, "underwater visual survey - 20 x 2m" = "20 x 2m",
                                "Underwater Visual Survey - 20 x 2m" = "20 x 2m",
                                "stationary visual census - 4 x 2m" = "4 x 2m",
                                "video plot" = "10min - 2 x 1m")) %>% 
  dplyr::rename("Sampling Protocol" = "samplingProtocol",
                "samples (n)" = "eventIDs.Freq",
                "replicate size" = "eventIDs.Var1") %>% 
  kable()

```


The number of sampling events grew over time, with a notable increase after 2012-2013, which is associated with the consolidation of the Sisbiota-Mar network, the increase in network members, and the total amount of financial support derived from network cooperative efforts. As an example, the inclusion of the ProspeqMar project, which has bioprospection and holobiotic investigation objectives, had an important contribution to the network from 2013 onwards.

```{r, echo = F, fig.height=5,fig.width=8,message=F, warning=F,fig.align= "center",out.width="100%",out.height="100%"}


# benthos
# number of eventIDs (rows per year)
eventIDs_year <- lapply (list_benthos, function (i) i %>% 
                           group_by (year,Dataset) %>% 
                           tally()  # the number of eventIDs
                         
                         )
# count the ids
eventIDs_year_benthos<-do.call(rbind,eventIDs_year) %>%
                           
                          group_by(year) %>%
                           
                          summarise (sum_cum = sum (n)) %>% # sum the number of ids per year
                          mutate(n_cum = cumsum(sum_cum)) # find the cumulative sum

# the beggining of each Dataset
begin_data <- do.call(rbind,eventIDs_year) %>%
                           
                          group_by(Dataset) %>%
                          
                          summarise (min_year = min (year,na.rm=T)) 


# fish
# number of eventIDs (rows per year)
eventIDs_yearB <- lapply (list_fish, function (i) i %>% 
                           group_by (year,Dataset) %>% 
                           tally()  # the number of eventIDs
                         
                         )
# count the ids
eventIDs_year_fish<-do.call(rbind,eventIDs_yearB) %>%
                           
                          group_by(year) %>%
                           
                          summarise (sum_cum = sum (n)) %>% # sum the number of ids per year
                          mutate(n_cum = cumsum(sum_cum)) # find the cumulative sum

# the beggining of each Dataset
begin_data_fish <- do.call(rbind,eventIDs_yearB) %>%
                           
                          group_by(Dataset) %>%
                          
                          summarise (min_year = min (year,na.rm=T)) 


# bind the years in the fish Dataset missing in the benthic Datasets
to_bind_benthos <- data.frame (year = c(2001, 2002,2020,2021,2022),
                               sum_cum=c(0,0,max(eventIDs_year_benthos$sum_cum),
                                          max(eventIDs_year_benthos$sum_cum),
                                          max(eventIDs_year_benthos$sum_cum)),
                               n_cum=c(0,0,max(eventIDs_year_benthos$n_cum),
                                       max(eventIDs_year_benthos$n_cum),
                                       max(eventIDs_year_benthos$n_cum)))

# bind
eventIDs_year_benthos <- bind_rows (eventIDs_year_benthos,
                                    to_bind_benthos) %>% 
  
              arrange (year)


# plot 
# benthos
trend_benthos <- ggplot (data = eventIDs_year_benthos, aes (x=year,y=n_cum)) + 
  geom_area(alpha=0.5, fill = "#FD8235", col = "gray30",size=2) + 
  theme(plot.background = element_rect("#EBEBEB"),
        panel.background = element_blank(),
        axis.title = element_text(color = "#292929", face = "bold"),
        axis.text = element_text(color = "#292929", face = "bold"),
        panel.grid = element_blank()) + 
  xlab ("") + ylab ("") 

trend_benthos_annotate <- trend_benthos + geom_text(data = begin_data, aes (x= min_year, y = 2500,
                                                  label = Dataset,
                                                  angle = 270),
                                                  size = 3) + 
  geom_segment(data = begin_data, 
               aes(x = min_year, y = 0, xend = min_year, yend = 1500)) + 
  geom_segment(aes(x = 2011, y = -100, xend = 2014, yend = -100),size=3,col="gray30")+
  geom_segment(aes(x = 2013, y = 100, xend = 2022, yend = 100),size=3,col="gray60")+
  geom_segment(aes(x = 2020, y = 300, xend = 2022, yend = 300),size=3,col="#5A8F7B")

# fish
trend_fish <- ggplot (data = eventIDs_year_fish, aes (x=year,y=n_cum)) + 
  geom_area(alpha=0.5, fill = "#6CC4A1", col = "gray30",size=2) + 
  theme(plot.background = element_rect("#EBEBEB"),
        panel.background = element_blank(),
        axis.title.y = element_text(color = "#292929", face = "bold"),
        axis.text.y = element_text(color = "#292929", face = "bold"),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),# element_text(color = "#292929", face = "bold"),
        panel.grid = element_blank()) + 
  xlab ("") + ylab ("") 

trend_fish_annotate <- trend_fish + geom_text_repel(data = begin_data_fish, aes (x= min_year, y = 15000,
                                                  label = Dataset,
                                                  angle = 270),
                                                  size = 3,
                                                  box.padding=0) + 
  geom_segment(data = begin_data_fish, 
               aes(x = min_year, y = 0, xend = min_year, yend = 10000)) +
  geom_segment(aes(x = 2011, y = -400, xend = 2014, yend = -400),size=3,col="gray30")+
  geom_segment(aes(x = 2013, y = 500, xend = 2022, yend = 500),size=3,col="gray60")+
  geom_segment(aes(x = 2020, y = 1300, xend = 2022, yend = 1300),size=3,col="#5A8F7B")+
  scale_y_reverse()


grid.arrange (trend_benthos_annotate,
              trend_fish_annotate,
              nrow=2,
              left = "Cumulative number of sampling events (eventIDs)") 



```
Fig. 3: The number of sampling events accumulated over time for benthos (top) and fish (bottom). One sampling event consist, for example, on one transect deployed into a locality. The vertical segments indicate the year in which data included in each dataset started to be collected. The horizontal bars depict the formal funding as follows: dark gray bar: Sisbiota, CNPq; light gray bar: PELD, CNPq; green bar: ReefSYN, Sinbiose CNPq. 


# Paper section 4: Temporal trends on the number of species

It is also natural that the cumulative sampling effort over time produces more scientific knowledge regarding the number of identified species or taxa. Here, we counted the cumulative number of scientific names or taxon names (after checking with the WORMS database, using the R package "worrms"). As indicated in Fig. 4, there was a nearly constant increase in the number of fish scientific names over time. In contrast, for benthos, there were sudden increases in the number of identified taxa over years (Fig. 4).

```{r, echo = F, fig.height=5,fig.width=8,message=F, warning=F, fig.align= "center",out.width="100%",out.height="100%"}

# load Datasets
# benthos
ds1_occ<- read.csv (here::here("DwC_output","AAued_spatialData", "DF_occ.csv"))
ds1_occ$year<- ds1 [match (ds1_occ$eventID, ds1$eventID), "year"]
ds2_occ<- read.csv (here::here("DwC_output","GLongo_NRoss_spatialData", "DF_occ_benthos.csv"))
ds2_occ$year<- ds2 [match (ds2_occ$eventID, ds2$eventID), "year"]

ds3_occ<- read.table (here::here("DwC_output","PELD_iloc_benthos", "DF_occ.txt"), sep = ",",h=T) # no meu pc, sep = ";"
ds3_occ$year<- ds3 [match (ds3_occ$eventID, ds3$eventID), "year"] 
## PROBLEMA -> eventID ESTA COM FORMATO ERRADO (PARTES REPETIDAS, ex. BR:PELD-ILOC:Noronha_Ponta_da_Sapata_2017_noronhaponta_da_sapata2017fundoT1Q7PS_2017_FUNDO_T1_Q7)
colnames(ds3_occ)[which(colnames(ds3_occ) == "island")] <- "site"
colnames(ds3_occ)[which(colnames(ds3_occ) == "eventYear")] <- "year"
ds3_occ$higherGeography <- "BrazilianOceanicIslands"

ds4_occ<- read.csv (here::here("DwC_output","RFrancini_spatialData", "DF_occ.csv"))
ds4_occ$year<- ds4 [match (ds4_occ$eventID, ds4$eventID), "year"]
ds5_occ<- read.csv (here::here("DwC_output","RFrancini_timeSeries_abrolhos","DF_occ_benthos.csv"))
ds5_occ$year<- ds5 [match (ds5_occ$eventID, ds5$eventID), "year"]

# fish

ds6_occ<- read.csv (here::here("DwC_output","GLongo_NRoss_spatialData", "DF_occ_fish.csv"))
ds6_occ$year<- ds6 [match (ds6_occ$eventID, ds6$eventID), "year"]
ds7_occ<- read.csv (here::here("DwC_output","GLongo_spatialData", "DF_occ.csv"))
ds7_occ$year<- ds7 [match (ds7_occ$eventID, ds7$eventID), "year"]
ds8_occ<- read.table (here::here("DwC_output","PELD_iloc_fish", "DF_occ.txt"), h=T, sep = ";")
ds8_occ$higherGeography <- "BrazilianOceanicIslands"
ds8_occ$year<- ds8 [match (ds8_occ$eventID, ds8$eventID), "year"]
ds9_occ<- read.csv (here::here("DwC_output","RFrancini_timeSeries_abrolhos","DF_occ_fish.csv"))
ds9_occ$year<- ds9 [match (ds9_occ$eventID, ds9$eventID), "year"]
ds10_occ<- read.csv (here::here("DwC_output","RJ_time_series", "DF_occ.csv"))
ds10_occ$year<- ds10 [match (ds10_occ$eventID, ds10$eventID), "year"]
ds11_occ<- read.csv (here::here("DwC_output","RMorais_spatialData", "DF_occ.csv"))
ds11_occ$year<- ds11 [match (ds11_occ$eventID, ds11$eventID), "year"]
ds12_occ<- read.csv (here::here("DwC_output","SC_time_series", "DF_occ.csv"))
ds12_occ$year<- ds12 [match (ds12_occ$eventID, ds12$eventID), "year"]



# list of sites with sampling of benthic communities
list_occ_benthos <- list(data.frame (ds1_occ, Dataset = "Sisbiota-Mar"),
                     data.frame (ds2_occ, Dataset = "RN monitoring"),
                     data.frame (ds3_occ, Dataset ="PELD ILOC"),
                     data.frame (ds4_occ, Dataset = "Coastal snapshots"),
                     data.frame (ds5_occ, Dataset = "Abrolhos Bank")
                     )



# ================
# fish

list_occ_fish <- list(data.frame (ds6_occ, Dataset = "RN monitoring"),
                  data.frame (ds7_occ, Dataset = "Sisbiota-Mar (VP)"),
                  data.frame (ds8_occ, Dataset = "PELD ILOC"),
                  data.frame (ds9_occ, Dataset = "Abrolhos Bank"),
                  data.frame (ds10_occ, Dataset = "Arraial do Cabo"),
                  data.frame (ds11_occ, Dataset = "Sisbiota-Mar (UVC)"),
                  data.frame (ds12_occ, Dataset = "Santa Catarina"))





## project richness

# benthos
# number of spp year (rows per year)

spp_year <- do.call(rbind,
                    
                    lapply (list_occ_benthos, function (i)  
                      
                    
                        i %>% select (year, scientificName, Dataset) # interesting columns
  
                              
                       )) %>% 
  
                dcast (formula = year ~ scientificName, # table
                                  drop=T) %>%
                        
                  
                  set_rownames(.$year)   # set rownames

                    
                

# composition matrix
spp_year <-  ifelse (spp_year >=1,1,0)
spp_year <- spp_year [,-which(colnames(spp_year) == "NA")]# rm NA cols

# aggregate
agg_data_year1 <- sum (spp_year[1,-1]>0)
acc_time <- lapply (seq (2,nrow(spp_year)), function (i){
  
        agg_data <- aggregate (
               data.frame (spp_year[1:i,]), 
                   by = list (spp_year[1:i,"year"]),
                   FUN = sum)[,-c(1,2)]
        sum_sp <- sum (agg_data>0)
        sum_sp
})
acc_time<- c(agg_data_year1, unlist(acc_time))
acc_time <- data.frame(SR = acc_time, 
           year = as.numeric(rownames(spp_year)))
acc_time<-rbind (acc_time,
                 data.frame  (SR=max(acc_time$SR), 
                              year=c(2020,2021,2022)))

# fish 

spp_year_fish <- do.call(rbind ,
                    
                    lapply (list_occ_fish, function (i)  
                      
                    
                        i %>% select (year, scientificName, Dataset) # interesting columns
  
                              
                       )) %>% 
  
                dcast (formula = year ~ scientificName, # table
                                  drop=T)# %>%
                        
                  
                 # set_rownames(.$year)   # set rownames

                    
                

# composition matrix
spp_year_fish <-  ifelse (spp_year_fish >=1,1,0)
spp_year_fish <- spp_year_fish [,-which(colnames(spp_year_fish) == "NA")]# rm NA cols

# aggregate
agg_data_year1_fish <- sum (spp_year_fish[1,-1]>0)
acc_time_fish <- lapply (seq (2,nrow(spp_year_fish)), function (i){
  
        agg_data <- aggregate (
               data.frame (spp_year_fish[1:i,]), 
                   by = list (spp_year_fish[1:i,"year"]),
                   FUN = sum)[,-c(1,2)]
        sum_sp <- sum (agg_data>0)
        sum_sp
})
acc_time_fish <- c(agg_data_year1_fish, unlist(acc_time_fish))
acc_time_fish <- data.frame(SR = acc_time_fish, 
           year = seq (2000, 2022))
#acc_time_fish$year <- as.Date(as.character(acc_time_fish$year), format = "%Y")


# plot 
# benthos
trend_benthos_SR <- ggplot (data = acc_time, 
                            aes (x= (year),y=SR)) + 
  geom_area(alpha=0.5, fill = "#FD8235", col = "gray30",size=2) + 
  theme(plot.background = element_rect("#EBEBEB"),
        panel.background = element_blank(),
        axis.title = element_text(color = "#292929", face = "bold"),
        axis.text = element_text(color = "#292929", face = "bold"),
        panel.grid = element_blank()) + 
  xlab ("") + ylab ("") +
  
  # projects 
  geom_text_repel(data = begin_data, aes (x= min_year, y = 100,
                                                  label = Dataset,
                                                  angle = 270),
                                                  size = 3,
                                                  box.padding=0) + 
  geom_segment(data = begin_data, 
               aes(x = min_year, y = 0, xend = min_year, yend = 80)) + 
  
  # grants
  geom_segment(aes(x = 2011, y = -5, xend = 2014, yend = -5),size=3,col="gray30")+
  geom_segment(aes(x = 2013, y = 4, xend = 2022, yend = 4),size=3,col="gray60")+
  geom_segment(aes(x = 2020, y = 12, xend = 2022, yend = 12),size=3,col="#5A8F7B")

# fish
trend_fish_SR <- ggplot (data = acc_time_fish, aes (x=year, y=SR)) + 
  geom_area(alpha=0.5, fill = "#6CC4A1", col = "gray30",size=2) + 
  theme(plot.background = element_rect("#EBEBEB"),
        panel.background = element_blank(),
        axis.title.y = element_text(color = "#292929", face = "bold"),
        axis.text.y = element_text(color = "#292929", face = "bold"),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),# element_text(color = "#292929", face = "bold"),
        panel.grid = element_blank()) + 
  xlab ("") + ylab ("") +
  
  scale_y_reverse() + # talvez seja melhor manter a escala normal
  # projects
  geom_text_repel(data = begin_data_fish, aes (x= min_year, y = 300,
                                                  label = Dataset,
                                                  angle = 270),
                                                  size = 3,
                                                  box.padding=0) + 
  geom_segment(data = begin_data_fish, 
               aes(x = min_year, y = 0, xend = min_year, yend = 300)) + 
  
  # grants
  geom_segment(aes(x = 2011, y = -10, xend = 2014, yend = -10),size=3,col="gray30")+
  geom_segment(aes(x = 2013, y = 13, xend = 2022, yend = 13),size=3,col="gray60")+
  geom_segment(aes(x = 2020, y = 40, xend = 2022, yend = 40),size=3,col="#5A8F7B")


# arrange plots
grid.arrange(trend_benthos_SR,
             trend_fish_SR,
             nrow=2,
              left = "Cumulative number of scientificNames")

```
Fig. 4: Trends in the number of scientific names accumulated over time for benthos (top) and fish (bottom). The vertical segments depict the year in which data included in each Dataset started to be collected. The horizontal bars depict the formal funding as follows: dark gray bar: Sisbiota, CNPq; light gray bar: PELD, CNPq; green bar: ReefSYN, Sinbiose CNPq. 


*ADD LIST OF SPECIES AND TAXONOMICAL CLASSIFICATION*


# Paper section 5: Brief description of each data set

*RESUMIR EM UMA TABELA COM NÚMERO DE SITES E AMOSTRAS, E COBERTURA TEMPORAL POR SITE*

## Spatial data (snapshots)
### Fish communities from the Brazilian province (Sisbiota-Mar (UVC), Figs. 2 and 3)
This dataset, used by Morais et al. (2017), includes fish counts and size estimates in 4,570 transects distributed over 137 localities in 20 different sites spanning from 0° to 27°S latitude degrees (including oceanic islands). Sampling descriptors include *Observer ID*, *site depth*, and *date*. The geographical information (coordinates) is indicated here at the site level (i.e., represents a set of replicates of transects in a given time and place).
The method used to sample fish was underwater visual census (UVC) with 20 × 2m in dimension, and samples were obtained in the austral summer from 2007 to 2011. Strip transects performed by free or scuba diving, during which the diver unwound a tape while identifying, counting and estimating the total length (LT, cm) of non-cryptic fishes >10 cm. And, while retracting the tape, following the same procedure for benthic-associated non-cryptic fishes <10 cm and cryptic species (see Morais et al. 2017 for more details). 

### Benthic communities from the Brazilian province (Sisbiota-Mar, Figs. 2 and 3)
This dataset, used by Aued et al. (2018) -- data also published at [DRYAD](https://doi.org/10.5061/dryad.f5s90), includes site-level cover information of ~100 benthic taxa from 3,855 photoquadrats deployed in 40 localities from 15 different sites, spanning 0° to 27°S latitude degrees. The sampling sites indicated here are the same in Morais et al. (2017). Six to twenty 2m2 horizontal surfaces of reef area on each depth strata were haphazardly selected for taking photoquadrats (25 x 25 cm) and
characterized the benthic community. Each 2m2 area was set, at least, 2 meters apart from each other and considered as independent sample units. Benthic organisms were identified at the lowest possible taxonomic level (i.e., morphotype, species, order) according to constraints related to image identification. Sampling descriptors include *photoquadrat ID*, *site depth*, *date* or *year* and, for some samples, *observer ID*. The geographical information is indicated at the site level.

### Benthic communities from the Brazilian province (Coastal snapshots, Figs. 2 and 3)
This dataset was compiled by Erika Santana, Anaíde Aued, and Ronaldo Francini-Filho, and consists of data on benthic organisms sampled in photoquadrats deployed in several sites disposed along the coast and oceanic islands. This dataset is complimentary to the dataset of Aued et al. (2018). Benthic organisms were identified at different taxonomic levels (morphotype, species, order). The dataset originally had environmental descriptors such as *site depth*, *month* and *year*, which were adequate here using DwC standards. 

### Trophic interactions along the Western Atlantic (Sisbiota-Mar(VP), Figs. 2 and 3)
This dataset, used by Longo et al. (2019), includes records of feeding behavior of fish over the benthic community, as well interactions among fish. These data were obtained with 1,133 unique videoplots deployed in 70 localities from 17 different sites spanning 61 degrees of latitude, from 34°N to 27°S. Sampling descriptors include *recording time*, *date*, *depth*, and *observed ID*. At each site, static videos were replicated at 2 × 1 m areas positioned haphazardly on the reefs, with 5–10 m between replicates. Feeding pressure was estimated as the product of the number of bites taken and the body mass (in kilograms) of the fish, accounting for body size variation. Individual biomass was obtained through length–weight relationships from the literature (Froese & Pauly, 2016).

## Time Series
### Benthic communities from oceanic islands (PELD-ILOC, Figs. 2 and 3)
Dataset of benthic communities recorded in the four oceanic islands of Brazil: Fernando de Noronha Archipelago, Rocas' Atoll, Trindade Island and Martiz Vaz Archipelago, and Saint Peter and Saint Paul's Archipelago. Data were collected from 2013 to 2019, organized by Thiago Silveira and Cesar Cordeiro (PELD-ILOC team) and is curated by Dr. Cesar Cordeiro. These data were generated by the team of [PELD ILOC project](http://peldiloc.sites.ufsc.br/), and is still being sampled anually. The method for registering the benthic commuinity 


Different depths were included because of different
geomorphological shapes at each site. While Cagarras and Ponta
da Sapata have shallow reefs, Laje Dois Irmãos has reefs only
from 10 m-deep, which provided representativeness of different
benthic groups. At each site we traced three to six 20 m-transects
in parallel to the coastline and spaced apart by 2 m, and fixed
them with rebar to maintain the same sampling area across
the years. We sampled 10–11 50 × 50 cm photoquadrats at
each transect each year

Image processing consisted on the identification of major
taxonomic and functional benthic groups and on the estimate
of their percentage cover in each sampling year. Therefore,
we used the Coral Point Count with Excel extensions software
(CPCe v. 4.1) (Kohler and Gill, 2006). We performed the analysis
by overlaying 50 random points on each image and visually
identifying the organisms below each point, gathering them into
major groups according to their recognized role in the reef
ecosystem:

details in Zamoner et al. (2021) doi: 10.3389/fmars.2021.762453


### Fish communities from oceanic islands (PELD-ILOC, Figs. 2 and 3)
Dataset of fish recorded in the four oceanic islands of Brazil: Fernando de Noronha Archipelago, Rocas' Atoll, Trindade Island and Martiz Vaz Archipelago, and Saint Peter and Saint Paul's Archipelago. Data were collected from 2013 to 2019, organized by Juan Quimbayo, Thiago Silveira and Cesar Cordeiro (PELD-ILOC team) and is curated by Dr. Cesar Cordeiro. The method used to sample fish was the underwater visual census (UVC). These data were generated by the team of [PELD ILOC project](http://peldiloc.sites.ufsc.br/) applying the same UVS protocol (20 x 2m strip transect) described above and used by Morais et al. (2017). Transects were laid at different depths at 5m intervals according to local maximum depths, ranging from 3 to 25m deep.

### Fish and benthic communities from Rio Grande do Norte (RN monitoring, Figs. 2 and 3)
Data collected by Guilherme Longo and Natália Roos in Rio Grande do Norte. Data of fishes and benthos were collected in the same spatial unit, within a transect of 20m2 used to register fishes, they also deployed 10 photoquadrats to register benthic organisms. These data were used in a publication by Natalia Roos [Roos et al. 2019](https://www.int-res.com/prepress/m13005.html). Data have been collected anually since 2016, at depths ...

### Fish communities from Santa Catarina (Santa Catarina, Figs. 2 and 3)
The data was collected annualy by the [LBMM team](https://lbmm.ufsc.br/), from 2007 to 2021. Dataset includes fish species, size and abundance recorded at 40m2 (20x2m) belt-transects in nine sites along the Santa Catarina state coastal area. Transects were laid at different depths at, approximately, 5m intervals according to local maximum depths, ranging from 1 to 25m deep. This dataset was submitted as a datapaper and it will soon be available.

### Fish communities from Arraial do Cabo, Rio de Janeiro (Arraial do Cabo, Figs. 2 and 3)
Data from Carlos EL Ferreira and Thiago C. Mendes. Data collected from xxx to xxxx.

The data was collected by the [LECAR team](https://www.lecar.uff.br/). Date from samplings spams from 2003 to 2021, but were annually collected only from 2014 to 2021 at four of the 21 sites monitored. Dataset includes fish species, size and abundance recorded at 40m2 (20x2m) belt-transects in rocky reefs in Arraial do Cabo, Rio de Janeiro. Transects were laid at different depths at, approximately, 5m intervals according to local maximum depths, ranging from 1 to 25m deep. Samples include data from two distinct oceanographic domains present locally, one under strong influence of seasonal upwelling, and another with indirect influence of the upwelling.

### Fish assemblages and benthic communities from Abrolhos Bank (Abrolhos Bank, Figs. 2 and 3)
Fish assemblage data from the Abrolhos Bank was collected by Ronaldo Francini-Filho along several years of work at the region, associated with projects funded by XXX (#) and YYY (#) from 2001 to 2014 The dataset here include samples of five sites and 28 localities nested within sites but not evenly distributed (see table Xs for details). The variables in this dataset are related to the description of fishes id and abundance, measured at stationary visual censuses (4 x 2 m, XX min). Depth fo sampling varied among sites and ranged between 2 and 15m.
Benthic communities assessments were completed at the same sites, localities and depths of fish stationary censuses, using either point-intersect technique (four 10m-transects in each depth and locality) or photoquadrats (10 quadrats, 0.7m2).

### Benthic communities along the Brazilian coast
This is the shortest dataset, althought it includes benthic cover data of 24 localities in XX sites which were sampled unevenly. Some sites were visited twice, but localities within sites were sampled only once. Each sampling event is equivalent to an effort of five photoquadrats (0.495 m2) taken at one depth strata in each locality in one year.


## Auxiliary datasets (not in this publication)
### A trait dataset for Atlantic and Eastern Pacific fishes
Already published dataset compiled by Quimbayo et al. (2021)[Link](https://doi.org/10.1002/ecy.3298). These data include traits of 2,153 fish species. Traits describe activity, size, diet, distribution, and fishing price.

### Benthic traits from the Brazilian province
Unpublished data collected by Anaide Aued and collaborators (based on Costello et al. 2013). These data include functional traits of more than 100 taxa of benthic organisms. Traits describe mobility, size, growth form, trophic level, and accretion capacity.

### Coral traits of the Brazilian province 
Unpublished data collected J Bleuel, GO Longo, and other collaborators. These data include functional traits of 24 coral species. Traits describe reproduction mode and period, growth rate and form, and tolerance to depth, light, and temperature.  

### Reef fish aesthetic value
Unpublished data from Waechter et al. Dataset that collected data about people perception about the aesthethic value of Brazilian reef fish and seascape.

## Spatial polygons
### Marine habitats
Polygons of distribution of marine habitats published by Magris et al. (2021)[Link](https://doi.org/10.5061/dryad.xsj3tx9d1)

### Brazilian Protected Areas
Spatial polygons of all Brazilian Protected Areas (in land and sea). These spatial data were shared by Rafael Magris (ICMBio), and are available at ICMBio homepage [link](https://www.gov.br/icmbio/pt-br/servicos/geoprocessamento/mapa-tematico-e-dados-geoestatisticos-das-unidades-de-conservacao-federais).

## How can you access these data?
These data are published under CC BY-NC licence. "Policy of data sharing and use" can be found in the ReefSYN Organization in Github (available [here](https://github.com/Sinbiose-Reefs/reefsyn_site/blob/master/DataPolicy_SINBIOSE.pdf)). Data embargo goes up to **January 2024**, one year after the end of ReefSYN funding.

### Funding
This project is funded by the Brazilian Biodiversity Synthesis Center - [SINBIOSE](http://www.sinbiose.cnpq.br/web/sinbiose) (CNPq #442417/2019-5, funding to MGB). The center is part of the National Council for Scientific and Technological Development (*Conselho Nacional de Desenvolvimento Científico e Tecnológico*, CNPq).Researchers from the "Brazilian Marine Biodiversity Research Network – SISBIOTA-Mar" (CNPq #563276/2010-0 and FAPESC #6308/2011-8 to SRF) and ‘‘Programa de Monitoramento de Longa Duração das Comunidades Recifais de Ilhas Oceânicas – PELD ILOC’’ (CNPq 441241/2016-6, to CELF), initiatives that collected and shared their data sets used in this research. ALL acknowledge the funding of CNPq (#164240/2021-7, #151228/2021-3, #152410/2020-1). GOL is grateful to a research productivity scholarship provided by the Brazilian National Council for Scientific and Technological Development (CNPq; 310517/2019-2) and Serrapilheira Institute (Grant No. Serra-1708-15364) for continued research support. 


### References
Darwin Core Task Group. 2009. Darwin Core. Biodiversity Information Standards (TDWG) http://www.tdwg.org/standards/450
Mark D. Spalding, Helen E. Fox, Gerald R. Allen, Nick Davidson, Zach A. Ferdaña, Max Finlayson, Benjamin S. Halpern, Miguel A. Jorge, Al Lombana, Sara A. Lourie, Kirsten D. Martin, Edmund McManus, Jennifer Molnar, Cheri A. Recchia, James Robertson, Marine Ecoregions of the World: A Bioregionalization of Coastal and Shelf Areas, BioScience, Volume 57, Issue 7, July 2007, Pages 573–583, https://doi.org/10.1641/B570707
Reichman OJ, Jones MB, Schildhauer MP. Challenges and opportunities of open data in ecology. Science. 2011 Feb 11;331(6018):703-5. doi: 10.1126/science.1197962. PMID: 21311007.
UNESCO, 2021. UNESCO Recommendation on Open Science. Available at: https://unesdoc.unesco.org/ark:/48223/pf0000379949. 34 pages
Wüest, RO, Zimmermann, NE, Zurell, D, et al. Macroecology in the age of Big Data – Where to go from here? J Biogeogr. 2020; 47: 1– 12. https://doi.org/10.1111/jbi.13633